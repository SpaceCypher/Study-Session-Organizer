{% extends "base.html" %}

{% block title %}Edit Session - Study Session Organizer{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Edit Study Session</h1>
    
    <div class="bg-white rounded-lg shadow-sm p-6">
        <form id="edit-session-form" class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Subject *</label>
                <select id="subject_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                    <option value="">Select a subject</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                <select id="location_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                    <option value="">Select a location (optional)</option>
                </select>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date *</label>
                    <input type="date" id="session_date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Max Participants *</label>
                    <input type="number" id="max_participants" required min="2" max="15" value="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Start Time *</label>
                    <input type="time" id="start_time" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">End Time *</label>
                    <input type="time" id="end_time" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <textarea id="description" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="What will you study? Any specific topics?"></textarea>
            </div>
            
            <div class="flex gap-4">
                <button type="submit" class="flex-1 bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700 transition duration-200 font-medium">
                    Update Session
                </button>
                <a href="/sessions/{{ session_id }}" class="flex-1 text-center bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition duration-200 font-medium">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
const sessionId = {{ session_id }};

document.addEventListener('DOMContentLoaded', () => {
    loadSubjects();
    loadLocations();
    loadSessionData();
    document.getElementById('edit-session-form').addEventListener('submit', handleSubmit);
});

async function loadSessionData() {
    try {
        const data = await apiCall(`/sessions/${sessionId}`);
        const session = data.data;
        
        // Get the subject_id from the session data
        const subjectSelect = document.getElementById('subject_id');
        
        // Wait for subjects to load, then set the value
        await loadSubjects();
        
        // Find subject_id from session data (might need adjustment based on actual data structure)
        const subjectQuery = `SELECT subject_id FROM SESSION_SUBJECT WHERE session_id = ${sessionId}`;
        // For now, we'll need to add an endpoint or include this in the session data
        
        document.getElementById('session_date').value = session.session_date;
        document.getElementById('start_time').value = session.start_time.substring(0, 5); // HH:MM format
        document.getElementById('end_time').value = session.end_time.substring(0, 5);
        document.getElementById('max_participants').value = session.max_participants;
        document.getElementById('description').value = session.description || '';
        
        // Set location if available
        if (session.location_id) {
            document.getElementById('location_id').value = session.location_id;
        }
        
    } catch (error) {
        console.error('Failed to load session:', error);
        showToast('Failed to load session data', 'error');
    }
}

async function loadSubjects() {
    const select = document.getElementById('subject_id');
    select.innerHTML = '<option value="">Select a subject</option>';
    
    try {
        const data = await apiCall('/subjects', 'GET');
        if (data.success && data.data) {
            data.data.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.subject_id;
                option.textContent = subject.subject_name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Failed to load subjects:', error);
        showToast('Failed to load subjects', 'error');
    }
}

async function loadLocations() {
    const select = document.getElementById('location_id');
    select.innerHTML = '<option value="">Select a location (optional)</option>';
    
    try {
        const data = await apiCall('/locations', 'GET');
        if (data.success && data.data) {
            data.data.forEach(location => {
                const option = document.createElement('option');
                option.value = location.location_id;
                option.textContent = `${location.building_name || location.building} - Room ${location.room_number} (Capacity: ${location.capacity})`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Failed to load locations:', error);
        showToast('Failed to load locations', 'error');
    }
}

async function handleSubmit(e) {
    e.preventDefault();
    
    const locationId = document.getElementById('location_id').value;
    
    const formData = {
        subject_id: document.getElementById('subject_id').value,
        date: document.getElementById('session_date').value,
        start_time: document.getElementById('start_time').value + ':00',
        end_time: document.getElementById('end_time').value + ':00',
        max_participants: parseInt(document.getElementById('max_participants').value),
        description: document.getElementById('description').value
    };
    
    if (locationId) {
        formData.location_id = parseInt(locationId);
    }
    
    try {
        const data = await apiCall(`/sessions/${sessionId}`, 'PUT', formData);
        showToast('Session updated successfully!', 'success');
        setTimeout(() => {
            window.location.href = '/sessions/' + sessionId;
        }, 1000);
    } catch (error) {
        console.error('Failed to update session:', error);
        showToast('Failed to update session', 'error');
    }
}
</script>
{% endblock %}
