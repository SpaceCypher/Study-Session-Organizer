{% extends "base.html" %}

{% block title %}My Sessions - Study Session Organizer{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">My Study Sessions</h1>
    
    <!-- Tabs -->
    <div class="bg-white rounded-lg shadow-sm mb-6">
        <div class="border-b border-gray-200">
            <nav class="flex -mb-px">
                <button onclick="filterSessions('upcoming')" 
                        class="session-tab flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm active"
                        data-filter="upcoming">
                    Upcoming
                </button>
                <button onclick="filterSessions('completed')" 
                        class="session-tab flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm"
                        data-filter="completed">
                    Completed
                </button>
                <button onclick="filterSessions('cancelled')" 
                        class="session-tab flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm"
                        data-filter="cancelled">
                    Cancelled
                </button>
            </nav>
        </div>
    </div>

    <!-- Sessions Container -->
    <div id="sessions-container" class="space-y-4">
        <!-- Sessions will be loaded here -->
    </div>
</div>

<!-- Feedback Modal -->
<div id="feedbackModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-lg bg-white">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-900">Submit Session Feedback</h3>
            <button onclick="closeFeedbackModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="feedbackForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Effectiveness Rating *
                    <span class="text-gray-500 text-xs">(How effective was this study session?)</span>
                </label>
                <div class="flex items-center gap-4">
                    <input type="range" id="effectiveness_rating" min="1" max="5" step="0.5" value="3" class="flex-1" oninput="document.getElementById('effectiveness_value').textContent = this.value">
                    <span id="effectiveness_value" class="text-lg font-semibold text-teal-600 w-8">3</span>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>Poor (1)</span>
                    <span>Excellent (5)</span>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Learning Improvement *
                    <span class="text-gray-500 text-xs">(How much did you learn?)</span>
                </label>
                <div class="flex items-center gap-4">
                    <input type="range" id="learning_improvement" min="1" max="5" step="0.5" value="3" class="flex-1" oninput="document.getElementById('learning_value').textContent = this.value">
                    <span id="learning_value" class="text-lg font-semibold text-teal-600 w-8">3</span>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>Nothing (1)</span>
                    <span>A lot (5)</span>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Would you attend similar sessions? *</label>
                <div class="flex gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="would_repeat" value="true" checked class="mr-2">
                        Yes
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="would_repeat" value="false" class="mr-2">
                        No
                    </label>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Overall Experience *</label>
                <select id="outcome_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                    <option value="Positive">Positive</option>
                    <option value="Neutral">Neutral</option>
                    <option value="Negative">Negative</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Additional Comments</label>
                <textarea id="comments" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="Share your thoughts about the session..."></textarea>
            </div>
            
            <div class="flex gap-4">
                <button type="submit" class="flex-1 bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700 transition duration-200 font-medium">
                    Submit Feedback
                </button>
                <button type="button" onclick="closeFeedbackModal()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition duration-200 font-medium">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentFilter = 'upcoming';

document.addEventListener('DOMContentLoaded', () => {
    loadMySessions();
});

function filterSessions(filter) {
    currentFilter = filter;
    
    // Update active tab
    document.querySelectorAll('.session-tab').forEach(tab => {
        if (tab.dataset.filter === filter) {
            tab.classList.add('active', 'border-teal-500', 'text-teal-600');
            tab.classList.remove('border-transparent', 'text-gray-500');
        } else {
            tab.classList.remove('active', 'border-teal-500', 'text-teal-600');
            tab.classList.add('border-transparent', 'text-gray-500');
        }
    });
    
    loadMySessions();
}

async function loadMySessions() {
    const container = document.getElementById('sessions-container');
    container.innerHTML = '<p class="text-center text-gray-600 py-8">Loading sessions...</p>';
    
    try {
        let statusFilter = '';
        if (currentFilter === 'upcoming') statusFilter = 'Planned,Active';
        else if (currentFilter === 'completed') statusFilter = 'Completed';
        else if (currentFilter === 'cancelled') statusFilter = 'Cancelled';
        
        const data = await apiCall(`/sessions/my-sessions?status=${statusFilter}`);
        
        if (data.data.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12 text-gray-500">
                    <i data-feather="calendar-x" class="mx-auto mb-4" style="width: 48px; height: 48px;"></i>
                    <p class="text-lg font-medium">No ${currentFilter} sessions</p>
                    <a href="/sessions/create" class="mt-4 inline-block text-teal-600 hover:text-teal-700 font-medium">Create a session</a>
                </div>
            `;
            feather.replace();
            return;
        }
        
        container.innerHTML = data.data.map(session => `
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition duration-200">
                <div class="p-6">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg text-gray-900 mb-2">${session.subject_name}</h3>
                            <p class="text-sm text-gray-600 mb-4">${session.description || 'No description'}</p>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600">
                                <div>
                                    <i data-feather="calendar" class="inline w-4 h-4"></i>
                                    ${formatDate(session.session_date)}
                                </div>
                                <div>
                                    <i data-feather="clock" class="inline w-4 h-4"></i>
                                    ${formatTime(session.start_time)}
                                </div>
                                <div>
                                    <i data-feather="map-pin" class="inline w-4 h-4"></i>
                                    ${session.building || 'TBD'} ${session.room_number || ''}
                                </div>
                                <div>
                                    <i data-feather="users" class="inline w-4 h-4"></i>
                                    ${session.participant_count}/${session.max_participants}
                                </div>
                            </div>
                        </div>
                        
                        <div class="ml-4 flex flex-col items-end gap-2">
                            <span class="px-3 py-1 text-xs font-medium rounded-full ${getStatusColor(session.status)}">
                                ${session.status}
                            </span>
                            ${session.role === 'Organizer' ? '<span class="px-3 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-800">Organizer</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="mt-4 flex gap-2 flex-wrap">
                        <a href="/sessions/${session.session_id}" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition duration-200 text-sm">
                            View Details
                        </a>
                        ${session.status === 'Planned' && session.role === 'Organizer' ? `
                            <button onclick="cancelSession(${session.session_id})" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200 text-sm">
                                Cancel Session
                            </button>
                        ` : ''}
                        ${session.status === 'Completed' && !session.has_feedback ? `
                            <button onclick="openFeedbackModal(${session.session_id})" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 text-sm">
                                Submit Feedback
                            </button>
                        ` : ''}
                        ${session.status === 'Completed' && session.has_feedback ? `
                            <span class="bg-green-100 text-green-800 px-4 py-2 rounded-lg text-sm font-medium">
                                âœ“ Feedback Submitted
                            </span>
                        ` : ''}
                    </div>
                </div>
            </div>
        `).join('');
        
        feather.replace();
        
    } catch (error) {
        console.error('Failed to load sessions:', error);
        container.innerHTML = `
            <div class="text-center py-12 text-red-500">
                <p class="text-lg font-medium">Failed to load sessions</p>
                <button onclick="loadMySessions()" class="mt-4 text-teal-600 hover:text-teal-700 font-medium">
                    Try again
                </button>
            </div>
        `;
    }
}

function getStatusColor(status) {
    const colors = {
        'Planned': 'bg-blue-100 text-blue-800',
        'Active': 'bg-green-100 text-green-800',
        'Completed': 'bg-gray-100 text-gray-800',
        'Cancelled': 'bg-red-100 text-red-800'
    };
    return colors[status] || 'bg-gray-100 text-gray-800';
}

async function cancelSession(sessionId) {
    if (!confirm('Are you sure you want to cancel this session? This will notify all participants.')) {
        return;
    }
    
    try {
        await apiCall(`/sessions/${sessionId}/cancel`, 'POST');
        showToast('Session cancelled successfully', 'success');
        loadMySessions();
    } catch (error) {
        console.error('Failed to cancel session:', error);
        showToast('Failed to cancel session', 'error');
    }
}

let currentFeedbackSessionId = null;

function openFeedbackModal(sessionId) {
    currentFeedbackSessionId = sessionId;
    document.getElementById('feedbackModal').classList.remove('hidden');
}

function closeFeedbackModal() {
    currentFeedbackSessionId = null;
    document.getElementById('feedbackModal').classList.add('hidden');
    document.getElementById('feedbackForm').reset();
    document.getElementById('effectiveness_value').textContent = '3';
    document.getElementById('learning_value').textContent = '3';
}

document.getElementById('feedbackForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!currentFeedbackSessionId) return;
    
    const formData = {
        effectiveness_rating: parseFloat(document.getElementById('effectiveness_rating').value),
        learning_improvement: parseFloat(document.getElementById('learning_improvement').value),
        would_repeat: document.querySelector('input[name="would_repeat"]:checked').value === 'true',
        outcome_type: document.getElementById('outcome_type').value,
        comments: document.getElementById('comments').value
    };
    
    try {
        await apiCall(`/sessions/${currentFeedbackSessionId}/feedback`, 'POST', formData);
        showToast('Feedback submitted successfully!', 'success');
        closeFeedbackModal();
        loadMySessions();
    } catch (error) {
        console.error('Failed to submit feedback:', error);
        showToast('Failed to submit feedback', 'error');
    }
});
</script>

<style>
.session-tab {
    border-color: transparent;
    color: #6b7280;
    transition: all 0.2s;
}

.session-tab:hover {
    color: #14b8a6;
    border-color: #14b8a6;
}

.session-tab.active {
    border-color: #14b8a6;
    color: #14b8a6;
}
</style>
{% endblock %}
